name: Update Coverage Badge

on:
  push:
    branches: [main]

# Minimal permissions - grant only what's needed per job
permissions: {}

jobs:
  coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to update README.md with new coverage badge
      actions: read    # Required to read workflow runs
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'

      - run: npm ci
      - run: npm test -- --coverage

      - name: Extract coverage and update badge
        run: |
          # Run coverage and capture output
          COVERAGE_OUTPUT=$(npm test -- --coverage 2>&1)
          
          # Extract coverage percentage from the "All files" line
          COVERAGE=$(echo "$COVERAGE_OUTPUT" | grep "All files" | awk '{print $4}' | head -1)
          
          # If we couldn't extract coverage, exit with error
          if [ -z "$COVERAGE" ]; then
            echo "Could not extract coverage percentage from output:"
            echo "$COVERAGE_OUTPUT"
            exit 1
          fi
          
          # Round to integer
          COVERAGE_INT=$(echo "$COVERAGE" | cut -d. -f1)
          
          # Determine color based on coverage
          if [ $COVERAGE_INT -ge 90 ]; then
            COLOR="brightgreen"
          elif [ $COVERAGE_INT -ge 80 ]; then
            COLOR="green"  
          elif [ $COVERAGE_INT -ge 70 ]; then
            COLOR="yellow"
          elif [ $COVERAGE_INT -ge 60 ]; then
            COLOR="orange"
          else
            COLOR="red"
          fi
          
          echo "Coverage: $COVERAGE% (rounded: $COVERAGE_INT%)"
          echo "Color: $COLOR"
          
          # Update the README badge
          sed -i "s/coverage-[0-9]*%25-[a-z]*/coverage-${COVERAGE_INT}%25-${COLOR}/g" README.md
          
          # Check if README was actually changed
          if git diff --quiet README.md; then
            echo "No changes to README.md"
          else
            echo "README.md updated with new coverage: $COVERAGE_INT%"
            git diff README.md
          fi

      - name: Commit updated badge
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if ! git diff --quiet README.md; then
            git add README.md
            git commit -m "Update coverage badge to $(grep -o 'coverage-[0-9]*%25' README.md | head -1 | grep -o '[0-9]*')%"
            git push
          else
            echo "No changes to commit"
          fi
