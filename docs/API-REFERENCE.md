# API Reference

Complete reference for all HanCover Action inputs, outputs, and configuration options.

## Inputs

### Required Inputs

| Input | Description | Example |
|-------|-------------|---------|
| `files` | Coverage file patterns (supports globs) | `coverage/lcov.info`<br>`**/cobertura.xml`<br>`coverage/*.xml` |

### Optional Inputs

| Input | Description | Default | Example |
|-------|-------------|---------|---------|
| `gist-id` | GitHub Gist ID for baseline storage (enables change badges) | - | `abc123def456789` |
| `github-token` | GitHub token for API access | `GITHUB_TOKEN` | `${{ secrets.GIST_TOKEN }}` |
| `min-threshold` | Minimum coverage for health indicators | `50` | `80` |
| `comment-mode` | Comment behavior: `update` (sticky) or `new` | `update` | `new` |
| `warn-only` | Don't fail on threshold violations | `false` | `true` |
| `baseline-files` | Baseline coverage files (alternative to gist) | - | `main-coverage.xml` |
| `thresholds` | Coverage requirements by category | - | `total:80\ndiff:75\nbranches:70` |

### Detailed Input Descriptions

#### `files`

Coverage file patterns using glob syntax. Supports multiple formats:

- **Single file**: `coverage/lcov.info`
- **Multiple files**: `coverage/*.xml`
- **Recursive search**: `**/cobertura.xml`
- **Multiple patterns**: Use YAML array syntax

#### `gist-id`

GitHub Gist ID for storing baseline coverage data. Enables:

- Coverage change badges in PR comments
- Dynamic README badges
- Change detection vs main branch

Required format: Alphanumeric string from Gist URL (e.g., `abc123def456789`)

#### `github-token`

GitHub token for API access. Requirements vary by setup:

- **Basic setup**: Uses default `GITHUB_TOKEN` automatically
- **Gist setup**: Requires token with `gist` scope
- **File-based setup**: Requires token with `contents: write` permission

#### `thresholds`

Multi-line string defining coverage requirements:

```yaml
thresholds: |
  total:80
  diff:75
  branches:70
  functions:85
```

Supported categories: `total`, `diff`, `branches`, `functions`, `lines`, `statements`

## Outputs

| Output | Description | Example |
|--------|-------------|---------|
| `coverage-pct` | Overall coverage percentage | `87.1` |
| `changes-coverage-pct` | Coverage for changed lines only | `91.3` |
| `coverage-delta` | Change vs baseline (when available) | `+1.9` |

### Output Usage Examples

```yaml
- name: Coverage Report
  id: coverage
  uses: farhan-ahmed1/hancover-action@v1
  with:
    files: coverage/lcov.info

- name: Check Coverage
  run: |
    echo "Overall coverage: ${{ steps.coverage.outputs.coverage-pct }}%"
    echo "Changes coverage: ${{ steps.coverage.outputs.changes-coverage-pct }}%"
    echo "Coverage delta: ${{ steps.coverage.outputs.coverage-delta }}%"
```

## Supported Coverage Formats

| Format | File Extensions | Common Tools | Auto-Detection |
|--------|----------------|--------------|----------------|
| **LCOV** | `.info` | Jest, Vitest, Karma, c8, nyc | ✅ |
| **Cobertura** | `.xml` | .NET, Python (coverage.py), Maven | ✅ |
| **JaCoCo** | `.xml` | Java, Kotlin, Scala | ✅ |
| **Clover** | `.xml` | PHP (PHPUnit), JavaScript | ✅ |

### Format-Specific Notes

#### LCOV

- Most common format for JavaScript/TypeScript projects
- Generated by Jest, Vitest, c8, nyc
- File extension: `.info`
- Example path: `coverage/lcov.info`

#### Cobertura

- XML-based format
- Common in .NET and Python ecosystems
- Auto-detected by `<coverage>` root element with `line-rate` attribute
- Example path: `coverage/cobertura.xml`

#### JaCoCo

- Java ecosystem standard
- XML-based format with `<report>` root element
- Auto-detected by `<package>` elements with `<class>` children
- Example path: `target/site/jacoco/jacoco.xml`

#### Clover

- PHP and some JavaScript tools
- XML-based format with `<coverage>` root element
- Auto-detected by `<project>` elements
- Example path: `build/logs/clover.xml`

## Security Limits

Built-in protections against malicious inputs:

| Limit | Value | Purpose |
|-------|-------|---------|
| **File size** | 50MB per file | Prevent memory exhaustion |
| **Total size** | 200MB total | Prevent disk exhaustion |
| **Parse depth** | 32 levels | Prevent XML bomb attacks |
| **Entity expansion** | Disabled | Prevent XXE attacks |

## Error Handling

### Common Error Scenarios

#### "No coverage files found"

**Cause**: File patterns don't match generated coverage files
**Solutions**:

- Verify coverage files are generated
- Check file paths and glob patterns
- Ensure test command runs before coverage action

#### "Failed to parse coverage file"

**Cause**: Invalid or corrupted coverage file
**Solutions**:

- Verify coverage generation completed successfully
- Check file format matches expected structure
- Ensure file is not truncated or corrupted

#### "Gist update failed"

**Cause**: Token permissions or Gist access issues
**Solutions**:

- Verify `GIST_TOKEN` has `gist` scope
- Ensure Gist exists and is public
- Check Gist ID is correct

#### "Threshold validation failed"

**Cause**: Coverage below specified thresholds
**Solutions**:

- Increase test coverage
- Adjust threshold values
- Use `warn-only: true` to prevent action failure

## Advanced Configuration

### Custom Package Grouping

Create `.coverage-report.json` in repository root:

```json
{
  "groups": [
    {
      "name": "Core Components",
      "patterns": ["src/components/**"],
      "exclude": ["src/components/legacy/**"]
    },
    {
      "name": "Utilities",
      "patterns": ["src/utils/**", "src/helpers/**"]
    }
  ],
  "ui": {
    "expandFilesFor": ["Core Components"]
  }
}
```

### Configuration Schema

#### `groups` (array, optional)

Custom package groupings that override smart defaults.

| Property | Type | Description | Required |
|----------|------|-------------|----------|
| `name` | string | Display name for the package group | ✅ |
| `patterns` | string[] | Glob patterns to match files | ✅ |
| `exclude` | string[] | Glob patterns to exclude from group | ❌ |

#### `ui` (object, optional)

User interface customization options.

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| `expandFilesFor` | string[] | Package names to expand file details | `[]` |

### Smart Defaults Behavior

When no configuration file exists, the action automatically:

1. **Groups by first path segment**: `src/`, `test/`, `packages/`
2. **Promotes deeper when logical**: If `src/` contains 80%+ of files, shows sub-directories
3. **Handles monorepos**: `packages/*/` becomes separate packages
4. **Excludes common patterns**: `node_modules/`, `.git/`, `dist/`

## Permissions Requirements

### Basic Setup (PR Comments Only)

```yaml
permissions:
  pull-requests: write  # Create and update PR comments
  contents: read       # Access repository files
```

### Enhanced Setup (with Gist)

```yaml
permissions:
  pull-requests: write  # Create and update PR comments
  contents: read       # Access repository files
  # Note: Gist access uses separate token with 'gist' scope
```

### File-Based Setup

```yaml
permissions:
  pull-requests: write  # Create and update PR comments
  contents: write      # Update baseline files in repository
```

## Rate Limiting

The action respects GitHub API rate limits:

- **Authenticated requests**: 5,000 per hour
- **Gist API**: Included in standard rate limit
- **PR comments**: No special limits (part of standard API)

Typical usage consumes 2-4 API calls per run:

- 1 call to fetch PR information
- 1 call to create/update comment
- 1-2 calls for Gist operations (if enabled)
